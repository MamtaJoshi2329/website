"use strict";var dpGcmMessaging,dpServiceWorkerRegistration,kFCMDiaryURL="/dp-api/cloud-messaging/dp-fcm-diary.php",kFCMRegistrationURL="/dp-api/cloud-messaging/dp-fcm-registration.php",kRegistrationTokenCookieKey="drik-fcm-registration-token",kRegistrationTokenUpdateCmdKey="token-update",kTokenRegistrationCmdKey="token-registration",kMessageDeliveryConfirmationCmd="message-delivery-confirmation",kWebPlatform="web",kAppName="drik-panchang",kFCMTokenKey="fcm-token",kFCMTopicKey="fcm-topic",kFCMDeliveryYYYYMMDDDateKey="fcm-delivery-date",kFCMPlatformKey="fcm-platform",kUTMMediumPushNotification="dp_push",kUTMSourcePushNotification="dp_web",kUTMCampaignPushNotification="dp_push_messaging",dpNotificationDataPostRequest=null,dpExpiredRegistrationToken="",dpFirebaseConfig={apiKey:"AIzaSyCYYJVYTUuW-WGTPCvH3vb6M7LsxzxbyKM",authDomain:"fir-drikpanchang.firebaseapp.com",databaseURL:"https://fir-drikpanchang.firebaseio.com",projectId:"firebase-drikpanchang",storageBucket:"firebase-drikpanchang.appspot.com",messagingSenderId:"816637316526",appId:"1:816637316526:web:39610abf8992b880c6cc3f",measurementId:"G-3GYFX0X6CX"};function handleNotificationPermissionTopicOptionClick(thisRef){$(thisRef).is(":checked")&&void 0!==dpGcmMessaging&&("denied"===Notification.permission?(DpDialog.showAlertMessage(dpNotificationDeniedMessage,DpImg.kImgErrorIcon),setTimeout(function(){$(".dpPopup").slideUp(200)},5e3)):requestNotificationPermission())}function initializePushNotification(){firebase.initializeApp(dpFirebaseConfig),(dpGcmMessaging=firebase.messaging()).usePublicVapidKey("BP7vG18NCNsp1dDBeVjr2MVQJ7Iis_EX58KVj9UTnNTTwJNFt7c3hmMXWynOPyhhz4_LbAr3oLcwiWHZZcTG2kc"),"granted"===Notification.permission&&requestNotificationPermission(),dpGcmMessaging.onMessage(function(payload){var notification,registrationToken=dpCookiesMngr.getCookie(kRegistrationTokenCookieKey),payload=JSON.parse(payload.data.dp_fcm_payload),title=payload.dp_title,description=payload.dp_description,smallImage=payload.dp_image_web_url,bigImage=payload.dp_big_image_web_url,url=payload.dp_topic_web_url,priorityWebUrl=payload.dp_priority_web_url,url=(void 0!==(url=void 0===priorityWebUrl||isEmpty(priorityWebUrl)?url:priorityWebUrl)&&!isEmpty(url)||(url="/index.html?src=dp"),void 0!==smallImage&&!isEmpty(smallImage)||(smallImage="https://www.drikpanchang.com/images/logo/2x/logo_panditji.png"),getNotificationOpenURL(payload,url)),priorityWebUrl=(postNotificationDataPayload(registrationToken,getDeliveryPayload(registrationToken,payload),kMessageDeliveryConfirmationCmd),{body:description,icon:smallImage,image:bigImage,tag:url});"Notification"in window?"granted"===Notification.permission&&((notification=new Notification(title,priorityWebUrl)).onclick=function(event){window.open(notification.tag),notification.close()}):console.log("This browser does not support system notifications")}),dpGcmMessaging.onTokenRefresh(function(){dpGcmMessaging.getToken().then(function(refreshedToken){sendTokenToWebServer(refreshedToken,kRegistrationTokenUpdateCmdKey)}).catch(function(err){console.log("Unable to retrieve refreshed token",err)})})}function requestNotificationPermission(){dpGcmMessaging.requestPermission().then(function(){var registrationToken=dpCookiesMngr.getCookie(kRegistrationTokenCookieKey);dpGcmMessaging.getToken().then(function(currentToken){currentToken&&currentToken!==registrationToken&&(console.log("cookie token is obsolete..."),sendTokenToWebServer(currentToken,kTokenRegistrationCmdKey))}).catch(function(err){console.log("An error occurred while retrieving token.",err)})}).catch(function(err){console.log("Unable to get permission to notify.",err)})}function sendTokenToWebServer(token,fcmCommand){kRegistrationTokenUpdateCmdKey===fcmCommand&&(dpExpiredRegistrationToken=dpCookiesMngr.getCookie(kRegistrationTokenCookieKey)),dpCookiesMngr.setCookie(kRegistrationTokenCookieKey,""),postNotificationDataPayload(token,getRegistrationPayload(token,fcmCommand),fcmCommand)}function isEmpty(value){return null==value||0===value.length}function getRegistrationPayload(token,fcmCommand){var geonameId=dpCookiesMngr.getCookie("drik-geoname-id"),appLanguage=dpCookiesMngr.getCookie("drik-language"),appTheme=dpCookiesMngr.getCookie("drik-website-theme"),geoElevationStatus=dpCookiesMngr.getCookie("drik-geo-elevation-status"),schoolType=dpCookiesMngr.getCookie("drik-school-name"),timeFormat=dpCookiesMngr.getCookie("drik-time-format"),clockType=dpCookiesMngr.getCookie("drik-clock"),sunriseSnapshotType=dpCookiesMngr.getCookie("drik-sunrise-type"),arithmeticType=dpCookiesMngr.getCookie("drik-arithmetic"),regionalNumeral=dpCookiesMngr.getCookie("drik-numeral-locale"),geonameId=isEmpty(geonameId)?"1261481":geonameId,appLanguage=isEmpty(appLanguage)?"en":appLanguage,appTheme=isEmpty(appTheme)?"classic":appTheme,geoElevationStatus=isEmpty(geoElevationStatus)?"disabled":geoElevationStatus,schoolType=isEmpty(schoolType)?"purnimanta":schoolType,timeFormat=isEmpty(timeFormat)?"12hour":timeFormat,clockType=isEmpty(clockType)?"modern":clockType,sunriseSnapshotType=isEmpty(sunriseSnapshotType)?"edges":sunriseSnapshotType,arithmeticType=isEmpty(arithmeticType)?"modern":arithmeticType,geoElevationStatus="disabled"===geoElevationStatus?0:1,regionalNumeral="english"===(isEmpty(regionalNumeral)?"english":regionalNumeral)?0:1,timezone="unknown";try{timezone=Intl.DateTimeFormat().resolvedOptions().timeZone}catch(err){console.log("support for DateTimeFormat() not available")}var browserType=getUserBrowser(),devicePlatform=getOSPlatform(),width=window.screen.width*window.devicePixelRatio,height=window.screen.height*window.devicePixelRatio,width=Math.floor(width)+"x"+Math.floor(height);return{"fcm-command":fcmCommand,"registration-token":token,"geoname-id":geonameId,"serialized-geo":"","expired-registration-token":dpExpiredRegistrationToken,"topics-bitmap":3298551693334,"channel-bitmap":0,"registration-token-timestamp":"",theme:appTheme,"app-language":appLanguage,"default-rashi":"mesha","localized-numeral":regionalNumeral,"elevation-status":geoElevationStatus,"calendar-type":"hindu","school-type":schoolType,"time-format":timeFormat,"clock-type":clockType,"sunrise-type":sunriseSnapshotType,"arithmetic-type":arithmeticType,"device-timezone":timezone,"device-platform":kWebPlatform,"app-name":kAppName,"app-version":browserType,"device-density":width,"subscription-status":0,"device-software":devicePlatform}}function getNotificationOpenURL(payloadDataObj,url){var topic=payloadDataObj.dp_topic_int_value,payloadDataObj=payloadDataObj.dp_dispatched_yyyymmdd_date;return url+"&utm_source="+kUTMSourcePushNotification+"&utm_medium="+kUTMMediumPushNotification+"&utm_campaign="+kUTMCampaignPushNotification+"&"+kFCMTopicKey+"="+topic+"&"+kFCMPlatformKey+"="+kWebPlatform+"&"+kFCMDeliveryYYYYMMDDDateKey+"="+payloadDataObj}function getDeliveryPayload(token,payloadDataObj){var topic=payloadDataObj.dp_topic_int_value,payloadDataObj=payloadDataObj.dp_dispatched_yyyymmdd_date;return{"fcm-command":kMessageDeliveryConfirmationCmd,"registration-token":token,topic:topic,"dispatched-yyyymmdd-date":payloadDataObj,"device-platform":kWebPlatform}}function postNotificationDataPayload(token,payloadData,fcmCommand){dpNotificationDataPostRequest=$.ajax({type:"POST",url:kMessageDeliveryConfirmationCmd===fcmCommand?kFCMDiaryURL:kFCMRegistrationURL,data:JSON.stringify({dp_payload:payloadData}),contentType:"application/json; charset=utf-8",beforeSend:function(){null!==dpNotificationDataPostRequest&&dpNotificationDataPostRequest.abort()},success:function(result){kMessageDeliveryConfirmationCmd===fcmCommand?console.log("Delivery details to server sent successfully!"):(dpCookiesMngr.setCookie(kRegistrationTokenCookieKey,token),console.log("Registration details to server sent successfully!")),dpNotificationDataPostRequest=null},error:function(){kMessageDeliveryConfirmationCmd===fcmCommand?console.log("failed to send delivery details to server!"):console.log("failed to send registration details to server!"),dpNotificationDataPostRequest=null}})}function getUserBrowser(){var platform="Unknown";return-1!==(navigator.userAgent.indexOf("Opera")||navigator.userAgent.indexOf("OPR"))?platform="Opera":-1!==navigator.userAgent.indexOf("Edg")?platform="Edge":-1!==navigator.userAgent.indexOf("Chrome")?platform="Chrome":-1!==navigator.userAgent.indexOf("Safari")?platform="Safari":-1!==navigator.userAgent.indexOf("Firefox")?platform="Firefox":-1===navigator.userAgent.indexOf("MSIE")&&!0!=!!document.documentMode||(platform="IE"),platform}function getOSPlatform(){var platform="Unknown";return-1!==window.navigator.userAgent.indexOf("Windows NT 10.0")?platform="Windows 10":-1!==window.navigator.userAgent.indexOf("Windows NT 6.3")?platform="Windows 8.1":-1!==window.navigator.userAgent.indexOf("Windows NT 6.2")?platform="Windows 8":-1!==window.navigator.userAgent.indexOf("Windows NT 6.1")?platform="Windows 7":-1!==window.navigator.userAgent.indexOf("Windows NT 6.0")?platform="Windows Vista":-1!==window.navigator.userAgent.indexOf("Windows NT 5.1")?platform="Windows XP":-1!==window.navigator.userAgent.indexOf("Windows NT 5.0")?platform="Windows 2000":-1!==window.navigator.userAgent.indexOf("Mac")?platform="Mac/iOS":-1!==window.navigator.userAgent.indexOf("X11")?platform="UNIX":-1!==window.navigator.userAgent.indexOf("Linux")&&(platform="Linux"),platform}document.addEventListener("DOMContentLoaded",function(){"serviceWorker"in navigator&&"PushManager"in window?navigator.serviceWorker.register("/firebase-messaging-sw.js").then(function(registration){dpServiceWorkerRegistration=registration,initializePushNotification()}).catch(function(error){console.log("failed to register service worker",error)}):console.warn("service worker or push notification support NOT available")});